# DNS(域名解析系统)

## 域名的层级
由于后面我会讲到 DNS 的解析过程，因此需要你对域名的层级有一些了解

1. 根域名 ：`.root` 或者 . ，通常是省略的
2. 顶级域名，如 `.com，.cn` 等
3. 次级域名(二级域名)，如 `baidu.com` 里的 baidu，这个是用户可以进行注册购买的
4. 主机域名(三级域名)，比如 `baike.baidu.com` 里的baike，这个是用户可分配的
5. `主机名.次级域名.顶级域名.根域名`baike.baidu.com.root`

## 域名的解析过程
### 一、原理
1. `主机`向`本地域名服务器`的`查询`一般都是采用`递归查询`。所谓递归查询就是：如果主机所询问的本地域名服务器不知道被查询的域名的IP地址，那么本地域名服务器就以DNS客户的身份，向其它根域名服务器继续发出查询请求报文(即替主机继续查询).
2. `本地域名服务器`向`根域名服务器`的`查询`的`迭代查询`。迭代查询的特点：当根域名服务器收到本地域名服务器发出的迭代查询请求报文时，要么给出所要查询的IP地址，要么告诉本地服务器：“你下一步应当向哪一个域名服务器进行查询”。然后让本地服务器进行后续的查询。

### 二、解析过程
1. 先查找游览器DNS缓存，有则返回，没有则进入下一步
1. 先查找本地 DNS 缓存（自己的电脑上），有则返回，没有则进入下一步
1. 查看本地 hosts 文件有没有相应的映射记录，有则返回，没有则进入下一步
1. 向本地 DNS 服务器（一般都是你的网络接入服务器商提供，比如中国电信，中国移动）发送请求进行查询，本地DNS服务器收到请求后，会先查下自己的缓存记录，如果查到了直接返回就结束了，如果没有查到，本地DNS服务器就会向DNS的根域名服务器发起查询请求：请问老大， www.163.com 的ip是啥
1. 根域名服务器收到请求后，看到这是个 .com 的域名，就回信说：这个域名是由 .com 老弟管理的，你去问他好了，这是.com老弟的联系方式（ip1）。
1. .com 顶级域名服务器接收到请求后，看到这是 163.com 的域名，就回信说：这个域名是 .163.com 老弟管理的，你就去问他就行了，这是他的联系方式（ip2）
1. 本地 DNS 服务器接收到回信后，按照前辈的指引（ip2），又向 .163.com 这个权威域名服务器发起请求：请问 163.com 大大，请问 www.163.com 的ip是啥？
1. `163.com` 权威域名服务器接收到请求后，确认了是自己管理的域名，马上查了下自己的小本本，把 www.163.com 的ip告诉了 本地DNS服务器
1. 本地DNS服务器接收到回信后，非常地开心，这下总算拿到了`www.163.com`的ip了，马上把这个消息告诉了要求查询的客户（就是你的电脑）。由于这个过程比较漫长，本地DNS服务器为了节省时间，也为了尽量不去打扰各位老大哥，就把这个查询结果偷偷地记在了自己的小本本上，方便下次有人来查询时，可以快速回应。

总结起来就是三句话：
* 从"根域名服务器"查到"顶级域名服务器"的NS记录和A记录（IP地址）
* 从"顶级域名服务器"查到"次级域名服务器"的NS记录和A记录（IP地址）
*从"次级域名服务器"查出"主机名"的IP地址

## DNS 劫持 与 HTTP 劫持
你一定见过当你在访问 某个网站时，右下角也突然弹出了一个扎眼的广告弹窗。这就是 HTTP 劫持。
当你想要访问 www.baidu.com 时，却返回给你 www.google.com 的ip，这就是我们常说的 DNS 劫持。

### DNS劫持方法
1. 本机DNS劫持
攻击者通过某些手段使用户的计算机感染上木马病毒，或者恶意软件之后，恶意修改本地DNS配置，比如修改本地hosts文件，缓存等。
2. 路由DNS劫持
很多用户默认路由器的默认密码，攻击者可以侵入到路由管理员账号中，修改路由器的默认配置。
3. 攻击DNS服务器
直接攻击DNS服务器，例如对DNS服务器进行DDOS攻击，可以是DNS服务器宕机，出现异常请求，还可以利用某些手段感染dns服务器的缓存，使给用户返回来的是恶意的ip地址。


### linux 命令
```shell
dig +trace www.baidu.com # 描述的 DNS 解析的详细过程  +short 直接返回对应着哪几个ip。
nslookup 查询 DNS 解析结果的工具
```

### DNS迭代查询与递归查询的区别
只要发出递归查询，服务器必需回答目标IP与域名的映射关系。
而迭代查询是，服务器收到一次迭代查询回复一次结果，这个结果不一定是目标IP与域名的映射关系，也可以是其它DNS服务器的地址。
从客户端到本地DNS服务器是属于递归查询，而DNS服务器之间就是的交互查询就是迭代查询。